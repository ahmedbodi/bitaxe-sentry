import json
import logging
import os
from pathlib import Path

logger = logging.getLogger(__name__)

# Define the path to the config file in the data directory
DATA_DIR = Path(os.getenv("DB_DATA_DIR", "/app/data"))  # Default to /app/data for dev
CONFIG_FILE_PATH = DATA_DIR / "config.json"

# Default settings
DEFAULT_SETTINGS = {
    "POLL_INTERVAL_MINUTES": 15,
    "RETENTION_DAYS": 30,
    "TEMP_MIN": 20,
    "TEMP_MAX": 70,
    "VOLT_MIN": 5.0,
    "BITAXE_ENDPOINTS": [],
    "DISCORD_WEBHOOK_URL": ""
}

def ensure_data_dir():
    """Ensure the data directory exists"""
    if os.getenv('KUBERNETES_SERVICE_HOST'):
        # In Kubernetes, the volume should already exist
        logger.info(f"Running in Kubernetes, assuming data directory {DATA_DIR} exists")
        return
    DATA_DIR.mkdir(exist_ok=True)

def load_settings():
    """Load settings from JSON file in data directory"""
    if os.getenv('KUBERNETES_SERVICE_HOST'):
        logger.info("Running in Kubernetes, skipping loading settings from file")
        config = DEFAULT_SETTINGS.copy()
        config['POLL_INTERVAL_MINUTES'] = int(os.getenv('POLL_INTERVAL_MINUTES', config['POLL_INTERVAL_MINUTES']))
        config['RETENTION_DAYS'] = int(os.getenv('RETENTION_DAYS', config['RETENTION_DAYS']))
        config['TEMP_MIN'] = float(os.getenv('TEMP_MIN', config['TEMP_MIN']))
        config['TEMP_MAX'] = float(os.getenv('TEMP_MAX', config['TEMP_MAX']))
        config['VOLT_MIN'] = float(os.getenv('VOLT_MIN', config['VOLT_MIN']))
        endpoints = os.getenv('BITAXE_ENDPOINTS', '')
        if endpoints:
            config['BITAXE_ENDPOINTS'] = [ep.strip() for ep in endpoints.split(',') if ep.strip()]
        config['DISCORD_WEBHOOK_URL'] = os.getenv('DISCORD_WEBHOOK_URL', config['DISCORD_WEBHOOK_URL'])
        return config
    ensure_data_dir()
    
    # If the file doesn't exist yet, create it with default settings
    if not CONFIG_FILE_PATH.exists():
        logger.info(f"No config file found at {CONFIG_FILE_PATH}, creating with defaults")
        save_settings(DEFAULT_SETTINGS)
        return DEFAULT_SETTINGS.copy()
    
    # Load settings from file
    try:
        logger.info(f"Loading settings from {CONFIG_FILE_PATH}")
        with open(CONFIG_FILE_PATH, 'r') as f:
            settings = json.load(f)
        
        # Ensure all required settings exist with defaults
        for key, default_value in DEFAULT_SETTINGS.items():
            if key not in settings:
                settings[key] = default_value
        
        # Ensure numeric values are properly converted
        try:
            settings["POLL_INTERVAL_MINUTES"] = int(settings["POLL_INTERVAL_MINUTES"])
            settings["RETENTION_DAYS"] = int(settings["RETENTION_DAYS"])
            settings["TEMP_MIN"] = float(settings["TEMP_MIN"])
            settings["TEMP_MAX"] = float(settings["TEMP_MAX"])
            settings["VOLT_MIN"] = float(settings["VOLT_MIN"])
            
            # Log the converted values for debugging
            logger.info(f"Loaded settings - POLL_INTERVAL_MINUTES: {settings['POLL_INTERVAL_MINUTES']}, "
                        f"VOLT_MIN: {settings['VOLT_MIN']}")
        except (ValueError, TypeError) as e:
            logger.error(f"Error converting settings values: {e}, using defaults")
            # Use defaults for any values that couldn't be converted
            settings["POLL_INTERVAL_MINUTES"] = DEFAULT_SETTINGS["POLL_INTERVAL_MINUTES"]
            settings["RETENTION_DAYS"] = DEFAULT_SETTINGS["RETENTION_DAYS"]
            settings["TEMP_MIN"] = DEFAULT_SETTINGS["TEMP_MIN"]
            settings["TEMP_MAX"] = DEFAULT_SETTINGS["TEMP_MAX"]
            settings["VOLT_MIN"] = DEFAULT_SETTINGS["VOLT_MIN"]
        
        return settings
    except Exception as e:
        logger.exception(f"Error loading settings: {e}")
        return DEFAULT_SETTINGS.copy()

def save_settings(settings_dict):
    """Save settings to JSON file in data directory"""
    if os.getenv('KUBERNETES_SERVICE_HOST'):
        logger.warning("Running in Kubernetes, skipping saving settings to file")
        return False  
    ensure_data_dir()
    
    # Convert string endpoints to list if needed
    if isinstance(settings_dict.get("BITAXE_ENDPOINTS"), str):
        endpoints = settings_dict["BITAXE_ENDPOINTS"].split(",")
        settings_dict["BITAXE_ENDPOINTS"] = [ep.strip() for ep in endpoints if ep.strip()]
    
    # Convert types to appropriate values
    try:
        settings_dict["POLL_INTERVAL_MINUTES"] = int(settings_dict.get("POLL_INTERVAL_MINUTES", DEFAULT_SETTINGS["POLL_INTERVAL_MINUTES"]))
        settings_dict["RETENTION_DAYS"] = int(settings_dict.get("RETENTION_DAYS", DEFAULT_SETTINGS["RETENTION_DAYS"]))
        settings_dict["TEMP_MIN"] = float(settings_dict.get("TEMP_MIN", DEFAULT_SETTINGS["TEMP_MIN"]))
        settings_dict["TEMP_MAX"] = float(settings_dict.get("TEMP_MAX", DEFAULT_SETTINGS["TEMP_MAX"]))
        settings_dict["VOLT_MIN"] = float(settings_dict.get("VOLT_MIN", DEFAULT_SETTINGS["VOLT_MIN"]))
        
        # Log the converted values for debugging
        logger.info(f"Saving settings - POLL_INTERVAL_MINUTES: {settings_dict['POLL_INTERVAL_MINUTES']}, "
                    f"VOLT_MIN: {settings_dict['VOLT_MIN']}")
    except (ValueError, TypeError) as e:
        logger.error(f"Error converting settings values: {e}")
        return False
    
    try:
        # Create a temporary file first to avoid corruption if the process is interrupted
        temp_file = CONFIG_FILE_PATH.with_suffix('.tmp')
        with open(temp_file, 'w') as f:
            json.dump(settings_dict, f, indent=2)
        
        # Rename the temporary file to the actual config file
        temp_file.replace(CONFIG_FILE_PATH)
        
        logger.info(f"Settings saved to {CONFIG_FILE_PATH}")
        return True
    except Exception as e:
        logger.exception(f"Error saving settings: {e}")
        return False 